# ドメイン駆動設計入門 ボトムアップでわかる！ドメイン駆動設計の基本

### 2.3 値オブジェクトにする基準

- ドメインモデルとして挙げられている概念は、値オブジェクトにする。
- ドメインモデルとして挙げられていない概念は、値オブジェクトにするかどうかの正当性はコンテキストによる。
- 著者の基準は「そこにルールが存在しているか」と「それ単体で取り扱いたいか」
- 氏名の場合
  - 「姓と名で構成される」というルールがある
  - 単体で比較などをされる
- 値オブジェクトとして定義するほどの価値がある概念を実装中に発見した場合、それはドメインモデルとしてフィードバックすべき。
- これがドメイン駆動設計が目的とするイテレーティブな開発で、実装時の気付きにより支えられる。

### 2.4 ふるまいをもった値オブジェクト

- 値オブジェクトはデータを保持するコンテナではない
- 加算などのふるまいが定義されていることで、加算できるということがわかる
- ルール外のふるまいをしようとするとエラーを送出できる
  - 通貨単位が違う場合は例外となる
- 逆に定義されていないふるまいはできないという制約も可能

### 2.5 値オブジェクトを採用するモチベーション

- クラスを増やすことに抵抗を感じる開発者は多いため、値オブジェクトを採用するにはこの心理的ハードルを越える必要がある
- そのためのモチベーションを紹介
  - 表現力を増す
  - 不正な値を存在させない
    - 例外の送出処理をクラス内にまとめられる
  - 誤った代入を防ぐ
    - 自己文書化を進める（コードの正しさをコードで表現する）
    - UserIdにUserNameを代入できないようにする
  - ロジックの散在を防ぐ
    - ルールをクラス内に納められる

## Chaper3 ライフサイクルのあるオブジェクト「エンティティ」

### 3.1 エンティティとは

- 値オブジェクトとの違いは同一性によって識別されるか否か
- 年齢を重ねると人は別人になるか？⇒No
- つまり、属性が同じかどうかではなく、それ以外の何かで同一性が担保されている
- システム管理の文脈では、ユーザ情報を編集しても別のユーザになってしまうことはありえない

### 3.2 エンティティの性質

- 可変である
  - 値オブジェクトは交換により変更を表現していたが、エンティティはそのふるまい（関数）を使って属性を変更する
    - 無味乾燥なget, setも使わない方が良さそう
  - ただし全ての属性を可変にするわけではなく必要に応じて許可されているだけ（限りなく不変が良い）
  - 例外送出はあくまでセーフティネットであり、処理前にチェックすべき
- 同じ属性であっても区別される
  - 値オブジェクトは同じ属性を持っているとおなじものとして扱われるが、エンティティはそうではない
  - 同姓同名は同一人物ではない
  - 見分けるためには識別子UserIdなどが属性に必要
- 同一性を持つ
  - ユーザ名の変更前後で同じユーザとして認識して欲しいはず
  - そのためには識別子を使用して同一性を判断
  - 識別子は同一性の実体であり、その性質から可変にする必要はない
  - 同一性を比較するためのふるまいも必要
- 値オブジェクトでは、全ての属性が比較対象であったが、エンティティでは識別子だけが比較の対象となる

### 3.3 エンティティの判断基準としてのライフサイクルと連続性

- 何を値オブジェクトとし、何をエンティティとするか
- ライフサイクルが存在し、そこに連続性があるかは大きな判断基準
- ユーザは作成されて生を受け、削除されて死を迎える、ライフサイクルを持ち、連続性のある概念
- ライフサイクルや連続性がない、持たせることが無意味そうなオブジェクトは値オブジェクトにする
  - 極力不変なオブジェクトで構成することがセオリー

### 3.4 値オブジェクトとエンティティどちらにもなりえるモデル

- 全く同じ概念をさしていてもシステムによって異なる
  - 車にとってはタイヤはパーツであるため、交換可能であり、値オブジェクトでは
  - タイヤ工場にとっては個体を識別することは重要であり識別子をもつエンティティ

### 3.5 ドメインオブジェクトを定義するメリット

- コードのドキュメント性が高まり、ドメインにおける変更をコードに伝えやすくなる
- このメリットは製造工程よりも、保守開発で際立つ
- 仕様書は残念ながらマクロな要件について有効であり、ミクロな要件については無力であることが多い
- 質の悪いことにドキュメントはコードと異なり、記載内容が間違っていても動作しなくなるような問題は引き起こさない
- ルールがオブジェクトに記載されていない、無口なコードの場合、そこに存在する暗黙のルールが守られているかは全てのコードを洗い出す必要がある。
- これは熟練した開発者であっても多大な労力が必要
- また後からルール変更することも容易

### 3.6 まとめ

- もしエンティティを実装しようとしてそこにあいまいさを感じたのであれば、それはドメインの捉え方を見つめなおすきっかけ




---
2023-04-24 : 51/341
